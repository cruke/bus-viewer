<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Bus Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display:flex; flex-direction:column; height:100%; }
    header {
      padding:8px 12px; background:#0b5bd3; color:#fff; font-weight:600; font-size:14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    #status { font-weight:600; font-size:12px; opacity:.95; }
    #map { flex:1; }

    /* small legend (Active buses) */
    .legend {
      position:absolute; bottom:10px; left:10px;
      background:rgba(255,255,255,0.95); padding:8px 10px; border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,.25); font-size:12px; max-width:240px; z-index:600;
    }
    .legend h4 { margin:0 0 6px 0; font-size:13px; }
    .legend-item { display:flex; align-items:center; gap:6px; margin:4px 0; cursor:pointer; }
    .colorbox { width:14px; height:10px; border-radius:3px; }
    .legend-item.active { background:#e7f1ff; border-radius:6px; padding:3px 4px; }

    /* hide Leaflet attribution for a clean screen (you can keep it if you prefer) */
    .leaflet-control-attribution, .leaflet-control-scale { display:none !important; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div>üöå Live Bus Viewer</div>
      <div id="status">Loading‚Ä¶</div>
    </header>
    <div id="map"></div>
  </div>

  <script>
    const WEB_APP_URL = '<?= ScriptApp.getService().getUrl() ?>';
  </script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ====== MAP SETUP ======
    const map = L.map('map', { attributionControl:false }).setView([3.54, 103.43], 13);
    // base + labels (street names visible)
    const base = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');
    const labels = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {opacity:0.9});
    base.addTo(map); labels.addTo(map);

    // Container for buses
    const buses = {};   // id -> { marker, trail, color }
    let focusedId = null;
    let firstFitDone = false;

    const statusEl = document.getElementById('status');

    // Clean bus icon (white circle)
    function busIconHtml() {
      return `<div style="width:34px;height:34px;background:#fff;border-radius:50%;
                        display:flex;align-items:center;justify-content:center;
                        font-size:20px; box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;">üöç</div>`;
    }
    const makeBusIcon = () => L.divIcon({
      html: busIconHtml(),
      iconSize: [34, 34],
      iconAnchor: [17, 17],
      className: 'bus-circle'
    });

    function randomColor() {
      const h = Math.floor(Math.random()*360);
      return `hsl(${h},80%,50%)`;
    }

    // Legend UI
    const legend = L.control({position:'bottomleft'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `<h4>Active Buses</h4><div id="legendList"></div>`;
      return div;
    };
    legend.addTo(map);
    const legendListEl = () => document.getElementById('legendList');

    function setStatus(msg) { statusEl.textContent = msg; }

    function kmh(spd_mps) {
      const n = Number(spd_mps);
      if (!Number.isFinite(n)) return '';
      return (n * 3.6).toFixed(1);
    }

    // Build/refresh legend entries & click-to-center
    function renderLegend(data) {
      const parent = legendListEl();
      parent.innerHTML = '';
      const ids = Object.keys(data).sort();
      ids.forEach(id => {
        const latest = data[id][0];
        const item = document.createElement('div');
        item.className = 'legend-item' + (id === focusedId ? ' active' : '');
        const color = buses[id]?.color || '#888';
        const destLabel = (latest.destination || '').toString().trim();
        item.innerHTML = `<div class="colorbox" style="background:${color}"></div>
                          <div>${id}${destLabel ? ' ('+destLabel+')' : ''}</div>`;
        item.onclick = () => {
          focusedId = id;
          const b = buses[id];
          if (b) map.setView(b.marker.getLatLng(), Math.max(14, map.getZoom()));
          renderLegend(data);
        };
        parent.appendChild(item);
      });
    }

    async function refresh() {
      try {
        const res = await fetch(WEB_APP_URL + '?json=1', { cache: 'no-store' });
        const js = await res.json();
        if (!js || !js.ok) {
          setStatus('Failed to load');
          return;
        }

        const data = js.buses || {};
        const ids = Object.keys(data);

        // Update or create markers/trails
        let any = false;
        const allPts = [];
        ids.forEach(id => {
          const rows = data[id];
          if (!rows || !rows.length) return;
          any = true;

          const latest = rows[0];
          const lat = Number(latest.lat), lng = Number(latest.lng);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          if (!buses[id]) {
            const color = randomColor();
            const marker = L.marker([lat, lng], { icon: makeBusIcon() }).addTo(map);
            const trail = L.polyline([], { color, weight:5, opacity:0.85 }).addTo(map);
            buses[id] = { marker, trail, color };
            // default focus first bus we see if none focused yet
            if (!focusedId) focusedId = id;
          }

          // update marker & trail (rows are newest-first already)
          const b = buses[id];
          b.marker.setLatLng([lat, lng]);
          b.trail.setLatLngs(rows.map(r => [Number(r.lat), Number(r.lng)]));

          // popup (opened only when user clicks the marker)
          const spd = kmh(latest.speed_mps);
          const ts = latest.timestamp ? new Date(latest.timestamp).toLocaleString() : '-';
          const plate = latest.plate || '-';
          b.marker.bindPopup(
            `<b>Bus ${id}</b><br>
             Dest: ${latest.destination || '-'}<br>
             Driver: ${latest.driver || '-'}<br>
             Plate: ${plate}<br>
             Speed: ${spd ? spd + ' km/h' : '-'}<br>
             Last: ${ts}`
          );

          b.marker.on('click', () => {
            // just open popup; do not change focus automatically here
            b.marker.openPopup();
          });

          // bounds
          rows.forEach(r => allPts.push([Number(r.lat), Number(r.lng)]));
        });

        // Remove stale buses (no longer in data)
        Object.keys(buses).forEach(id => {
          if (!ids.includes(id)) {
            map.removeLayer(buses[id].marker);
            map.removeLayer(buses[id].trail);
            delete buses[id];
            if (focusedId === id) focusedId = null;
          }
        });

        // Auto set initial view ONCE (don‚Äôt reset on every refresh)
        if (any && !firstFitDone) {
          if (focusedId && buses[focusedId]) {
            map.setView(buses[focusedId].marker.getLatLng(), 15);
          } else if (allPts.length) {
            map.fitBounds(allPts, { padding: [30, 30] });
          }
          firstFitDone = true;
        }

        // Update legend (click to center)
        renderLegend(data);

        // Status
        setStatus(any ? `Updated: ${new Date().toLocaleTimeString()}` : 'No buses yet');

      } catch (e) {
        setStatus('Fetch failed');
        console.warn('Viewer fetch failed:', e);
      }
    }

    // Initial + interval
    refresh();
    setInterval(refresh, 10000);
  </script>
</body>
</html>
