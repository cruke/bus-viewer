<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Bus Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin:0; height:100%; font-family:system-ui,sans-serif; }
    #map { height:100%; width:100%; }
    .leaflet-popup-content { font-size:0.9rem; line-height:1.3; }

    /* Welcome splash */
    #welcome {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0078ff, #00c6ff);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 14px;
      font-size: 1.6rem;
      font-weight: 600;
      z-index: 2000;
      transition: opacity 0.8s ease;
      text-align: center;
      padding: 0 20px;
    }
    #welcome .spinner {
      width: 56px; height: 56px;
      border: 4px solid rgba(255,255,255,0.35);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #welcome .hint { font-size: 1rem; font-weight: 400; opacity: 0.9; }
    #welcome .sub { font-size: 0.95rem; font-weight: 500; opacity: 0.85; }

    /* Legend */
    .legend {
      position:absolute; bottom:82px; left:10px;
      background:rgba(255,255,255,0.9); padding:6px 10px;
      border-radius:8px; font-size:0.9rem; box-shadow:0 2px 6px rgba(0,0,0,0.25);
      max-width:220px; z-index:700; display:none;
    }
    .legend h4 { margin:0 0 4px 0; font-size:0.95rem; }
    .legend-item { display:flex; align-items:center; gap:6px; margin:3px 0; }
    .colorbox { width:16px; height:10px; border-radius:3px; }

    /* Status toast */
    .status {
      position:absolute; top:10px; right:10px; z-index:700;
      background:rgba(0,0,0,.7); color:#fff; padding:6px 10px; border-radius:8px; font-size:.85rem;
    }

    /* Controls */
    .controls {
      position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
      display:grid; grid-template-columns:repeat(7,44px); gap:8px;
      z-index:800;
    }
    .controls button {
      width:44px; height:44px; border:none; border-radius:12px;
      font-size:20px; cursor:pointer;
      background:rgba(255,255,255,0.95);
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .controls button:active { transform:scale(0.97); }
  </style>
</head>
<body>
  <!-- Welcome splash -->
  <div id="welcome">
    <div>ğŸšŒ <b>Live Bus Viewer</b></div>
    <div class="spinner"></div>
    <div class="sub" id="welcomeSub">Loading active busesâ€¦</div>
    <div class="hint">ğŸ’¡ Press â—€ï¸ â–¶ï¸ to switch between buses</div>
  </div>

  <!-- Map UI -->
  <div id="map"></div>
  <div class="legend" id="legend"><h4>ğŸšŒ Active Buses</h4></div>
  <div class="status" id="status">Loadingâ€¦</div>

  <div class="controls">
    <button id="btnHome" title="Home">ğŸ </button>
    <button id="btnPrev" title="Previous bus">â—€ï¸</button>
    <button id="btnNext" title="Next bus">â–¶ï¸</button>
    <button id="btnMyLoc" title="My location">ğŸ“</button>
    <button id="btnMapType" title="Switch map type">ğŸ—ºï¸</button>
    <button id="btnLegend" title="Show/Hide Active Buses">ğŸ‘ï¸</button>
    <button id="btnFollow" title="Follow bus">ğŸ¯</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /* ---------- CONFIG ---------- */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby6mh0UYXsQyms8ZHWGl5fgDM2yUCBH7TfQ53zTS810KGLS8rLFFcijVTpGpoo2Ab5uAg/exec";
    const REFRESH_SEC = 10;
    const HOME = L.latLng(3.543784470063409, 103.42902640748252);

    /* ---------- MAP SETUP ---------- */
    const map = L.map('map').setView([3.54,103.43],13);
    const layers = {
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}),
      esriImagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Tiles &copy; Esri'}),
      esriStreets: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{attribution:'Tiles &copy; Esri'}),
      tonerLite: L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png',{attribution:'Map tiles by Stamen'})
    };
    map.createPane('labels');
    map.getPane('labels').style.zIndex = 650;
    map.getPane('labels').style.pointerEvents = 'none';
    const labelsOverlay = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', { pane:'labels', opacity:0.9 });
    let baseOrder = ['osm','esriImagery','esriStreets','tonerLite'];
    let baseIdx = 0;
    let baseLayer = layers[baseOrder[baseIdx]].addTo(map);
    if (!map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);
    function switchMapType() {
      map.removeLayer(baseLayer);
      baseIdx = (baseIdx + 1) % baseOrder.length;
      baseLayer = layers[baseOrder[baseIdx]].addTo(map);
      if (!map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);
    }
    function centerTo(ll) { map.setView(ll, map.getZoom(), { animate:true }); }

    /* ---------- STATE ---------- */
    const buses = {}, statusEl = document.getElementById('status');
    let busList = [], currentFocusId = null, myLocMarker = null;
    function status(msg){ statusEl.textContent = msg; }

    /* ---------- CLIPBOARD HELPERS ---------- */
    async function copyText(text){
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback: temporary textarea
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        status('ğŸ“‹ Copied: ' + text);
      } catch (e) {
        status('Copy failed');
      }
    }
    // Expose a global for popup inline onclick
    window.copyCoords = (lat, lng) => copyText(`${lat},${lng}`);

    /* ---------- REVERSE GEOCODE CACHE ---------- */
    const addrCache = new Map();
    async function getStreetName(lat,lng){
      const key = lat.toFixed(5)+','+lng.toFixed(5);
      if (addrCache.has(key)) return addrCache.get(key);
      try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const js = await res.json();
        const name = js.display_name || '';
        addrCache.set(key, name);
        return name;
      }catch{ return ''; }
    }

    function randomColor(){ const h=Math.floor(Math.random()*360); return `hsl(${h},80%,50%)`; }
    function makeBusIcon(id,color){
      return L.divIcon({
        className:'bus-icon',
        html:`<div style="text-align:center">
                <div style="background:${color};color:white;font-size:12px;padding:2px 5px;border-radius:5px;margin-bottom:2px">${id}</div>
                <div style="font-size:22px">ğŸšŒ</div>
              </div>`,
        iconSize:[40,46], iconAnchor:[20,40]
      });
    }

    function bringToFrontBus(id){
      Object.values(buses).forEach(b=>{ b.marker.setZIndexOffset(0); b.trail.bringToBack(); });
      if (buses[id]){ buses[id].marker.setZIndexOffset(1000); buses[id].trail.bringToFront(); }
    }

    /* ---------- SPLASH CONTROL ---------- */
    const welcome = document.getElementById('welcome');
    const welcomeSub = document.getElementById('welcomeSub');
    let splashTimerDone = false, firstDataLoaded = false;
    function maybeHideWelcome() {
      if (splashTimerDone && firstDataLoaded) {
        welcome.style.opacity = '0';
        setTimeout(()=>welcome.style.display='none',800);
      }
    }
    window.addEventListener('load', ()=>setTimeout(()=>{ splashTimerDone=true; maybeHideWelcome(); },3000));

    /* ---------- FETCH & UPDATE ---------- */
    async function updateMap(data){
      const ids = Object.keys(data);
      const legend = document.getElementById('legend');
      legend.innerHTML = '<h4>ğŸšŒ Active Buses</h4>';
      let any=false; const bounds=[];

      for(const id of ids){
        const rows=data[id]; if(!rows||!rows.length)continue;
        const latest=rows[0]; const lat=+latest.lat, lng=+latest.lng;
        if(!isFinite(lat)||!isFinite(lng))continue;
        any=true;
        if(!buses[id]){
          const color=randomColor(), icon=makeBusIcon(id,color);
          const marker=L.marker([lat,lng],{icon}).addTo(map);
          const trail=L.polyline([],{color,weight:5,opacity:0.8}).addTo(map);
          buses[id]={marker,trail,color};
        }
        const b=buses[id];
        b.trail.setLatLngs(rows.map(r=>[+r.lat,+r.lng]));
        b.marker.setLatLng([lat,lng]);
        const addr=await getStreetName(lat,lng);

        const gmapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
        const navUrl   = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

        b.marker.bindPopup(
          `<b>Bus ${id}</b><br>
           Dest: ${latest.destination || '-'}<br>
           ETA: ${latest.eta || '-'}<br>
           Driver: ${latest.driver || '-'}<br>
           Current: ${addr || '(Locating...)'}<br>
           Last: ${new Date(latest.timestamp).toLocaleString()}<br>
           <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
             <a href="${gmapsUrl}" target="_blank"
                style="padding:6px 10px;border-radius:8px;background:#eef3ff;color:#0b57d0;
                       text-decoration:none;font-weight:600;display:inline-block;">ğŸŒ Open in Google Maps</a>
             <a href="${navUrl}" target="_blank"
                style="padding:6px 10px;border-radius:8px;background:#e6f4ea;color:#137333;
                       text-decoration:none;font-weight:600;display:inline-block;">ğŸ§­ Get Directions</a>
             <a href="#" onclick="copyCoords(${lat},${lng}); return false;"
                style="padding:6px 10px;border-radius:8px;background:#fff3cd;color:#7a5200;border:1px solid #ffe08a;
                       text-decoration:none;font-weight:600;display:inline-block;">ğŸ“‹ Copy Coordinates</a>
           </div>`
        );

        bounds.push([lat,lng]);
        const dest=(latest.destination||'-').trim();
        const leg=document.createElement('div');
        leg.className='legend-item';
        leg.innerHTML=`<div class="colorbox" style="background:${b.color}"></div> <div>${id} (${dest})</div>`;
        legend.appendChild(leg);
      }

      Object.keys(buses).forEach(id=>{ if(!ids.includes(id)){ map.removeLayer(buses[id].marker); map.removeLayer(buses[id].trail); delete buses[id]; }});
      if(any&&bounds.length) map.fitBounds(bounds,{padding:[30,30]});
      status(any?`Updated: ${new Date().toLocaleTimeString()}`:'No buses yet');
      firstDataLoaded=true; welcomeSub.textContent='âœ… Data loaded. Initializing map...'; maybeHideWelcome();
    }

    async function refresh(){
      try{
        const res=await fetch(WEB_APP_URL+'?json=1',{cache:'no-store'});
        const js=await res.json();
        if(js&&js.ok) updateMap(js.buses);
        else status('Failed to load data');
      }catch(e){ status('Fetch failed'); }
    }
    refresh(); setInterval(refresh,REFRESH_SEC*1000);

    /* ---------- CONTROLS ---------- */
    const btnLegend=document.getElementById('btnLegend'), legendEl=document.getElementById('legend');
    let legendVisible=false;
    function toggleLegend(){ legendVisible=!legendVisible; legendEl.style.display=legendVisible?'block':'none'; btnLegend.textContent=legendVisible?'ğŸ™ˆ':'ğŸ‘ï¸'; }
    btnLegend.onclick=toggleLegend;

    document.getElementById('btnHome').onclick=()=>{centerTo(HOME);status('Centered: Home');};
    document.getElementById('btnMapType').onclick=switchMapType;
    document.getElementById('btnMyLoc').onclick=()=>{
      if(!navigator.geolocation)return status('No GPS');
      navigator.geolocation.getCurrentPosition(pos=>{
        const ll=L.latLng(pos.coords.latitude,pos.coords.longitude);
        if(!myLocMarker) myLocMarker=L.marker(ll,{icon:L.divIcon({className:'myloc',html:'<div style="font-size:22px">ğŸ“</div>',iconSize:[24,24],iconAnchor:[12,22]})}).addTo(map);
        else myLocMarker.setLatLng(ll);
        centerTo(ll); status('My location updated');
      });
    };
    document.getElementById('btnPrev').onclick=()=>status('â—€ï¸ Previous bus');
    document.getElementById('btnNext').onclick=()=>status('â–¶ï¸ Next bus');
  </script>
</body>
</html>
